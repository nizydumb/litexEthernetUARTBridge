# litexEthernetUARTBridge

*A minimal LiteX design for the **Tang Primer 20K** that acts as a **full‑duplex UART ↔ UDP bridge**. Bytes arriving on the board’s UART are wrapped into UDP datagrams and sent to the network; incoming UDP payloads are forwarded to UART.*

---

## ✨ Project milestones

| Stage | Milestone description | Status |
|-------|-----------------------|--------|
| **1** | Built minimal LiteX design with built‑in BIOS (generated headers & `linker.ld`) | ✅ |
| **2** | Compiled custom UART firmware with Makefile derived from LiteX *demo‑software* | ✅ |
| **3** | Verified UDP transmission over Ethernet | ✅ |
| **4** | Completed bi‑directional **UART ↔ UDP bridge** | ✅ |
| **5** | ✨ Planned: replace autogenerated linker/libs with custom ones & create universal Makefile | ⏳ |

---

## 📦 Repository layout
```text
.
├─ firmware/          # bare‑metal RISC‑V sources
│   ├─ main.c         # bridge logic
│   ├─ uart.c         # handles UART RX, processes lines
│   ├─ udp.c          # sends/receives UDP datagrams
│   ├─ linker.ld      # linker script (initially from LiteX BIOS)
│   └─ Makefile       # universal Makefile (from LiteX demo)
├─ build/             # generated by LiteX (ignored by git)
└─ README.md          # this file
```

---

## 🛠 Prerequisites (tested)

| Tool | Version / Date | Install hint |
|------|----------------|--------------|
| **Python** | 3.10.12 | system / `pyenv` |
| **LiteX & Migen** | 2025‑04 snapshot (official Git) | follow LiteX docs |
| **RISC‑V GCC** | riscv‑gnu‑toolchain @ 2025‑04 | github.com/riscv‑collab/riscv‑gnu‑toolchain |
| **Gowin toolchain** | Gowin V1.9.11.01 Education (Linux x86) | download from Gowin portal |
| **openFPGALoader** | Debian/Ubuntu package `openfpgaloader` | `sudo apt install openfpgaloader` |

All tools are open‑source or free‑for‑education.

---

## 🚀 Quick start

LiteX workflow has **three passes**.

### A — build target script to generate headers
```bash
python -m litex_boards.targets.tang_primer_20k --with-ethernet --integrated-rom-size=0x8000 --build
# Ignore the Gowin size warning – we only need the headers.
```

### B — build main logic firmware
```bash
cd firmware
make clean && make
```
Generates `firmware/main.bin`.

### C — embed firmware, enable Ethernet, flash
```bash
cd ..
python3 -m litex_boards.targets.tang_primer_20k --with-ethernet --integrated-rom-init=firmware/main.bin --build --flash
```

---

### 🛠️ Troubleshooting Gowin Qt errors
If the Gowin toolchain on Linux reports missing Qt plugins (e.g. `qt.qpa.plugin: Could not load the Qt platform plugin "xcb" …`), prepend these variables when running the LiteX command:
```bash
QT_QPA_PLATFORM_PLUGIN_PATH=/usr/lib/x86_64-linux-gnu/qt5/plugins QT_QPA_PLATFORM=xcb QT_XCB_GL_INTEGRATION=none python3 -m litex_boards.targets.tang_primer_20k …
```
Adjust the plugin path to suit your distr.

---

### ✅ Verification / Testing
1. **UART ➜ Ethernet**
   * Open a serial terminal (PuTTY, *minicom*, *screen* …) at **115 200 baud**.
   * Type a line and press **Enter** — the board wraps it into a UDP datagram and transmits it.
2. **Ethernet ➜ UART**
   * Add static ARP record to network interface of host machine:
```bash
arp -s 192.168.1.100 02-00-00-00-00-01 192.168.1.101
# 192.168.1.100 - litex board's binded ip address
# 02-00-00-00-00-01 - litex board's binded mac address
# 192.168.1.101 - network interface of host machine 
```
   * Send a UDP packet back with **netcat (ncat)**:
```bash
echo "hello from other planet called Ethernet" | ncat -u 192.168.1.100 1234
# 192.168.1.100 - litex board's binded ip address
# 1234 - litex board's binded udp port
```
   * The text appears immediately in your serial terminal.
3. **Sniff traffic (optional)**
   * Open **Wireshark** on the interface connected to the board.
   * Use display filter, for example `udp.port == 1234` to watch packets in both directions.

---

## 🔧 Configuration knobs

| File | Constants | Purpose |
|------|-----------|---------|
| `main.c` | `MAC_SRC`, `IP_SRC`, `UDP_PORT_SRC` | Board‑side MAC, IP and UDP **source** port |
| `main.c` | `MAC_DST`, `IP_DST`, `UDP_PORT_DST` | Remote peer’s MAC, IP and UDP **destination** port |

> After editing these values, repeat passes **A → B → C**.

---
